generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Player {
  id           String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  displayName String?
  displayNameNormalized String? @unique
  rating      Int           @default(1000)
  peakRating  Int           @default(1000)
  rankedGames Int           @default(0)
  rankedWins  Int           @default(0)
  rankedLosses Int          @default(0)
  rankedDraws Int           @default(0)
  runes       Int           @default(0)
  equippedCosmetic String?
  currentWinStreak Int      @default(0)
  conundrumSolves Int       @default(0)
  pendingChests Int         @default(0)
  userId      String?
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  authSessions AuthSession[]
  achievements PlayerAchievement[]
  inventory   PlayerInventory[]
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  players      Player[]
  authSessions AuthSession[]
  oauthAccounts OauthAccount[]
}

model AuthSession {
  id               String    @id @default(cuid())
  userId           String
  playerId         String?
  refreshTokenHash String
  createdAt        DateTime  @default(now())
  expiresAt        DateTime
  revokedAt        DateTime?
  replacedById     String?
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  player           Player?   @relation(fields: [playerId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([playerId])
}

model OauthAccount {
  id             String   @id @default(cuid())
  userId         String
  provider       String
  providerUserId String
  email          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
}

model PlayerAchievement {
  id            String   @id @default(cuid())
  playerId      String
  achievementId String
  unlockedAt    DateTime @default(now())
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, achievementId])
  @@index([playerId])
}

model PlayerInventory {
  id         String   @id @default(cuid())
  playerId   String
  itemId     String
  obtainedAt DateTime @default(now())
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, itemId])
  @@index([playerId])
}
